<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ø§Ù„Ø¨Ø§ØµØ§Øª</title>
  <style>
    body { font-family: Arial; direction: rtl; background: #f4f4f4; padding: 20px; }

    #loginPage, #mainSystem { display: none; }

    #loginPage {
      max-width: 400px;
      margin: 100px auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
    }

    h1, h2 { color: #333; }
    label { display: block; margin-top: 10px; }
    input, button { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; }
    button { background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    form { background: #fff; padding: 20px; margin-top: 20px; border-radius: 8px; box-shadow: 0 0 10px #ccc; }
    select { width: 100%; }

    .reminder { background: #ffeeba; padding: 15px; margin-bottom: 20px; border: 1px solid #f0ad4e; border-radius: 5px; }
    .print-btn { background: #28a745; color: #fff; border: none; padding: 10px; cursor: pointer; margin-top: 10px; border-radius: 5px; }

    @media print {
      body * { visibility: hidden; }
      #reservationTable, #reservationTable * { visibility: visible; }
      #reservationTable { position: absolute; top: 0; right: 0; left: 0; }
    }
  </style>
</head>
<body>

  <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginPage">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <form id="loginForm">
      <label>Ø§Ù„Ø§Ø³Ù…:</label>
      <input type="text" id="userName" required>
      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
      <input type="email" id="userEmail" required>
      <button type="submit">Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„</button>
    </form>
    <p id="loginMessage" style="margin-top:10px; color: green;"></p>
    <button onclick="approveManually()" style="margin-top: 20px; background: orange;">Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø´Ø±Ù (Ù„Ù„ØªØ¬Ø±Ø¨Ø©)</button>
  </div>

  <!-- Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª -->
  <div id="mainSystem">
    <div class="reminder">
      <strong>ØªØ°ÙƒÙŠØ±:</strong> ÙŠÙˆØ¬Ø¯ Ø­Ø¬Ø² ØºØ¯Ù‹Ø§. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒÙŠØ¯.
      <button onclick="acknowledgeReminder()">ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</button>
    </div>

    <h1>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h1>
    <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</button>
    <table id="reservationTable">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</th>
          <th>Ø§Ù„ÙˆØ¬Ù‡Ø©</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„ÙˆÙ‚Øª</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø§ØµØ§Øª</th>
          <th>Ø­Ø¬Ù… Ø§Ù„Ø¨Ø§Øµ</th>
          <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±Ù</th>
          <th>ØªØ¹Ø¯ÙŠÙ„</th>
          <th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¬Ø²</h2>
    <form id="reservationForm">
      <input type="hidden" id="editIndex" value="">
      <label>Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©:</label>
      <input type="text" id="entityName" required>
      <label>Ø§Ù„ÙˆØ¬Ù‡Ø©:</label>
      <input type="text" id="destination" required>
      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
      <input type="date" id="date" required>
      <label>Ø§Ù„ÙˆÙ‚Øª:</label>
      <input type="time" id="time" required>
      <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø§ØµØ§Øª:</label>
      <input type="number" id="busCount" required>
      <label>Ø­Ø¬Ù… Ø§Ù„Ø¨Ø§Øµ:</label>
      <select id="busSize">
        <option value="ØµØºÙŠØ±">ØµØºÙŠØ±</option>
        <option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</option>
        <option value="ÙƒØ¨ÙŠØ±">ÙƒØ¨ÙŠØ±</option>
      </select>
      <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±Ù Ù„Ù„ØªÙˆØ§ØµÙ„:</label>
      <input type="text" id="supervisorPhone" required>
      <button type="submit">Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø²</button>
    </form>
  </div>

  <!-- ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
  <audio id="alertSound" src="https://www.soundjay.com/button/beep-07.wav" loop></audio>

  <script>
    const loginPage = document.getElementById("loginPage");
    const mainSystem = document.getElementById("mainSystem");
    const loginForm = document.getElementById("loginForm");
    const loginMessage = document.getElementById("loginMessage");

    const approvedUsersKey = "approvedUsers";
    const currentUserKey = "currentUser";

    function checkUserAccess() {
      const currentUser = localStorage.getItem(currentUserKey);
      const approvedUsers = JSON.parse(localStorage.getItem(approvedUsersKey)) || [];

      if (currentUser && approvedUsers.includes(currentUser)) {
        loginPage.style.display = "none";
        mainSystem.style.display = "block";
        loadReservations();
        const reminder = document.querySelector(".reminder");
        if (reminder && reminder.style.display !== "none") {
          const audio = document.getElementById("alertSound");
          if (audio) audio.play();
        }
      } else {
        loginPage.style.display = "block";
        mainSystem.style.display = "none";
      }
    }

    loginForm.addEventListener("submit", function(e) {
      e.preventDefault();
      const name = document.getElementById("userName").value;
      const email = document.getElementById("userEmail").value;

      localStorage.setItem("pendingUser", JSON.stringify({ name, email }));
      localStorage.setItem(currentUserKey, email);

      alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯: Anahmed@mowasalat.com Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©");
      loginMessage.textContent = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©...";
    });

    function approveManually() {
      const pending = JSON.parse(localStorage.getItem("pendingUser"));
      if (pending && pending.email) {
        let approved = JSON.parse(localStorage.getItem(approvedUsersKey)) || [];
        if (!approved.includes(pending.email)) {
          approved.push(pending.email);
          localStorage.setItem(approvedUsersKey, JSON.stringify(approved));
          localStorage.setItem(currentUserKey, pending.email);
          alert("ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
          checkUserAccess();
        }
      }
    }

    const form = document.getElementById("reservationForm");
    const tableBody = document.querySelector("#reservationTable tbody");
    const LOCAL_STORAGE_KEY = "busReservations";

    function loadReservations() {
      tableBody.innerHTML = "";
      const data = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (data) {
        JSON.parse(data).forEach(res => addRowToTable(res));
      }
    }

    function saveReservations() {
      const rows = Array.from(tableBody.rows).map(row => {
        return {
          entityName: row.cells[0].textContent,
          destination: row.cells[1].textContent,
          date: row.cells[2].textContent,
          time: row.cells[3].textContent,
          busCount: row.cells[4].textContent,
          busSize: row.cells[5].textContent,
          supervisorPhone: row.cells[6].textContent
        };
      });
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(rows));
    }

    function addRowToTable(res) {
      const now = new Date();
      const reservationDateTime = new Date(`${res.date}T${res.time}`);
      const isPast = reservationDateTime < now;
      const rowColor = isPast ? 'background-color: #f8d7da;' : 'background-color: #d4edda;';

      const row = document.createElement("tr");
      row.setAttribute("style", rowColor);
      row.innerHTML = `
        <td>${res.entityName}</td>
        <td>${res.destination}</td>
        <td>${res.date}</td>
        <td>${res.time}</td>
        <td>${res.busCount}</td>
        <td>${res.busSize}</td>
        <td>${res.supervisorPhone || ''}</td>
        <td><button onclick="editReservation(this)">ØªØ¹Ø¯ÙŠÙ„</button></td>
        <td><button onclick="deleteReservation(this)">Ø­Ø°Ù</button></td>
      `;
      tableBody.appendChild(row);
    }

    function editReservation(button) {
      const row = button.closest("tr");
      const cells = row.querySelectorAll("td");

      document.getElementById("entityName").value = cells[0].textContent;
      document.getElementById("destination").value = cells[1].textContent;
      document.getElementById("date").value = cells[2].textContent;
      document.getElementById("time").value = cells[3].textContent;
      document.getElementById("busCount").value = cells[4].textContent;
      document.getElementById("busSize").value = cells[5].textContent;
      document.getElementById("supervisorPhone").value = cells[6].textContent;
      document.getElementById("editIndex").value = row.rowIndex - 1;
    }

    function deleteReservation(button) {
      const row = button.closest("tr");
      row.remove();
      saveReservations();
    }

    form.addEventListener("submit", function(e) {
      e.preventDefault();

      const entityName = document.getElementById("entityName").value;
      const destination = document.getElementById("destination").value;
      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const busCount = document.getElementById("busCount").value;
      const busSize = document.getElementById("busSize").value;
      const supervisorPhone = document.getElementById("supervisorPhone").value;
      const editIndex = document.getElementById("editIndex").value;

      const newReservation = {
        entityName, destination, date, time, busCount, busSize, supervisorPhone
      };

      if (editIndex === "") {
        addRowToTable(newReservation);
      } else {
        tableBody.deleteRow(editIndex);
        addRowToTable(newReservation);
        document.getElementById("editIndex").value = "";
      }

      saveReservations();
      form.reset();
    });

    function acknowledgeReminder() {
      document.querySelector(".reminder").style.display = "none";
      const audio = document.getElementById("alertSound");
      if (audio) audio.pause();
    }

    window.addEventListener("load", checkUserAccess);
  </script>
</body>
</html>
